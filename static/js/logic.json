const leafletMapId = "map-id";
const startingCoords = [39.8283, -98.5795]
const startingZoomLevel = 5;
const maxZoom = 18;
const leafletEndpoint = "https://api.mapbox.com/styles/v1/mapbox/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}";
const leafletAttribution = "Map data &copy; <a href=\"https://www.openstreetmap.org/\">OpenStreetMap</a> contributors, <a href=\"https://creativecommons.org/licenses/by-sa/2.0/\">CC-BY-SA</a>, Imagery Â© <a href=\"https://www.mapbox.com/\">Mapbox</a>";
const mapLayerSettings = [
	{
		name: "Statalite",
		id: "satellite-v9"
	},
	{
		name: "Grayscale",
		id: "light-v10"
	},
	{
		name: "Outdoors",
		id: "outdoors-v11"
	}
];
const mapOverlaySettings = [
	{
		name: "Earthquakes",
		endpoint: "https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_month.geojson",
		createLayerGroup: (json, err) => createEarthquakesLayerGroup(json, err),
	},
	{
		name: "Tectonic Plates",
		endpoint: "https://raw.githubusercontent.com/fraxen/tectonicplates/master/GeoJSON/PB2002_boundaries.json",
		createLayerGroup: (json, err) => createTectonicPlatesLayerGroup(json, err),
	},
];

// the overlays that will cover the map
var mapOverlays = {};												   
// Start the logic.js;
for (var i = 0; i < mapOverlaySettings.length; i++)
	loadOverlay(mapOverlaySettings[i]);


function loadOverlay(overlay) {
	d3.json(overlay.endpoint)
		.then((jsonData, err) => {
			mapOverlays[overlay.name] = overlay.createLayerGroup(jsonData, err);
			if (hasLoadedAllOverlays())
				createMap();

		}).catch((error) => console.log(error));
}

/**returns {Boolean} If all the overlays have loaded
 */
function hasLoadedAllOverlays() {
	for (var i = 0; i < mapOverlaySettings.length; i++) {
		if (mapOverlaySettings[i].name in mapOverlays == false)
			return false;
	}

	// if all the overlays exist in the mapOverlays, return true
	return true;
}

/**Create leaflet map
 */
function createMap() { 
	var mapLayers = createMapLayers();
	var map = L.map(leafletMapId, {
		center: startingCoords,
		zoom: startingZoomLevel,
		layers: [mapLayers[mapLayerSettings[0].name], ...Object.values(mapOverlays)]
	});

	// Create a layer control, pass in the baseMaps and mapOverlays. Add the layer control to the map
	L.control.layers(
		mapLayers,
		mapOverlays,
		{ collapsed: false }
	).addTo(map);

	// Add in the earthquakes color legend
	createEarthquakesColorLegend().addTo(map);
}

function createMapLayers() {
	var params = {
		attribution: leafletAttribution,
		maxZoom: maxZoom,
		accessToken: API_KEY
	};

	var mapLayers = {};

	for (var i = 0; i < mapLayerSettings.length; i++) {

		params.id = mapLayerSettings[i].id;
		mapLayers[mapLayerSettings[i].name] = L.tileLayer(leafletEndpoint, params);
	}

	return mapLayers;
}